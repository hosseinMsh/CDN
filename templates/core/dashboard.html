{% extends 'base.html' %}
{% block title %}Dashboard â€“ EdgeCDN{% endblock %}
{% block body %}
    <div class="max-w-7xl mx-auto p-6">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl md:text-3xl font-bold">EdgeCDN</h1>
            <div class="flex items-center gap-3">
                <span class="text-sm text-slate-600">{{ request.user.username }} Â· {{ request.user.name_spase }}</span>
                <a href="/accounts/logout/" class="text-sm px-3 py-2 rounded-lg bg-slate-900 text-white">Logout</a>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-4 border-b border-slate-200">
            <nav class="-mb-px flex gap-6" aria-label="Tabs">
                <button id="tab-explorer" class="tab active border-b-2 border-slate-900 px-1 pb-3 text-sm font-medium">
                    Explorer
                </button>
                <button id="tab-upload" class="tab px-1 pb-3 text-sm text-slate-600 hover:text-slate-900">Upload
                </button>
            </nav>
        </div>

        <!-- EXPLORER -->
        <section id="panel-explorer" class="space-y-4">
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                    <label class="text-sm text-slate-600">Main folder: </label>
                    <nav  class="flex items-center gap-1 text-sm">{{ request.user.name_spase }}/</nav>
                    <nav  class="flex items-center gap-1 text-sm"><input id="bucketFilter" value="assets" class="border rounded-lg px-3 py-2"/></nav>
                    
                </div>
                <nav id="crumbs" class="flex items-center gap-1 text-sm"></nav>
                <div class="ml-auto flex items-center gap-2">
                    <button id="btnNewFolder" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">New
                        folder
                    </button>
                    <input id="q" class="border rounded-lg px-3 py-2" placeholder="Search files..."/>
                    <button id="zipBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">Download ZIP
                    </button>
                </div>
            </div>

            <!-- Grid -->
            <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
            <div id="empty" class="hidden text-center text-slate-500 py-12">No items here.</div>

            <!-- Context Menu -->
            <div id="ctx" class="hidden fixed bg-white border rounded-lg shadow text-sm overflow-hidden z-50">
                <button data-act="open" class="block w-full text-left px-3 py-2 hover:bg-slate-100">Open</button>
                <button data-act="rename" class="block w-full text-left px-3 py-2 hover:bg-slate-100">Rename / Move
                </button>
                <button data-act="copy" class="block w-full text-left px-3 py-2 hover:bg-slate-100">Copy link</button>
                <button data-act="delete" class="block w-full text-left px-3 py-2 text-red-600 hover:bg-red-50">Delete
                </button>
            </div>
        </section>

        <!-- UPLOAD -->
        <section id="panel-upload" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-white rounded-2xl p-6 shadow">
                    <h2 class="font-semibold text-lg mb-4">Upload files</h2>
                    <div class="mb-3">
                        <label class="block text-sm text-slate-600 mb-1">Main folder</label>
                        <input id="bucket" value="assets" class="w-full border rounded-lg px-3 py-2"/>
                    </div>
                    <div class="mb-4 text-xs text-slate-500">
                        Target path is the <strong>current Explorer path</strong>:
                        <div>Current: <span id="currentPathHint" class="font-mono">/</span></div>
                    </div>
                    <div id="drop" class="border-2 border-dashed rounded-xl p-6 text-center hover:bg-slate-50">
                        <p class="text-sm text-slate-600 mb-3">Drag & drop files here</p>
                        <div class="flex flex-col gap-2 items-center">
                            <label class="cursor-pointer px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">
                                Choose files
                                <input id="files" type="file" multiple class="hidden"/>
                            </label>
                            <label class="cursor-pointer px-3 py-2 rounded-lg bg-slate-700 text-white text-sm">
                                Choose a folder (experimental)
                                <input id="folder" type="file" webkitdirectory directory class="hidden"/>
                            </label>
                        </div>
                        <p id="extInfo" class="mt-3 text-xs text-slate-500">Allowed: loadingâ€¦</p>
                    </div>
                    <div class="mt-4">
                        <button id="startUpload" class="w-full rounded-lg bg-slate-900 text-white py-2">Start upload
                        </button>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow">
                    <h3 class="font-semibold mb-4">Upload status</h3>
                    <div id="queue" class="space-y-2 text-sm"></div>
                    <div id="queueEmpty" class="text-slate-500 text-sm">No files in queue.</div>
                </div>
            </div>
        </section>
    </div>

    <style>
        .tab.active {
            color: #0f172a
        }

        .tile {
            background: #fff;
            border-radius: 0.75rem;
            padding: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .06);
            transition: .2s;
        }

        .tile:hover {
            box-shadow: 0 12px 28px rgba(0, 0, 0, .09);
        }
    </style>

    <script>
        /* ------------------------------
           Helpers
        ------------------------------ */
        const $ = s => document.querySelector(s);
        const grid = $('#grid'), emptyState = $('#empty'), crumbs = $('#crumbs'), ctx = $('#ctx');
        let currentPath = '';
        let selected = new Set();
        let cacheFolders = [], cacheFiles = [];
        let ctxTarget = null; // {name, url, mime}

        function fmtSize(n) {
            const u = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            while (n >= 1024 && i < u.length - 1) {
                n /= 1024;
                i++
            }
            return (i ? n.toFixed(1) : n) + ' ' + u[i];
        }

        function joinPath(...parts) {
            return parts.filter(Boolean).join('/');
        }

        function iconFolder() {
            return 'ðŸ“';
        }

        function iconFile(mime) {
            if (mime?.startsWith('image/')) return 'ðŸ–¼ï¸';
            if (mime?.includes('zip') || mime?.includes('tar')) return 'ðŸ—œï¸';
            if (mime?.includes('pdf')) return 'ðŸ“•';
            if (mime?.includes('audio')) return 'ðŸŽµ';
            if (mime?.includes('video')) return 'ðŸŽ¬';
            if (mime?.includes('css') || mime?.includes('javascript')) return 'ðŸ“„';
            return 'ðŸ“˜';
        }

        /* Tabs */
        const tabExplorer = $('#tab-explorer');
        const tabUpload = $('#tab-upload');
        const panelExplorer = $('#panel-explorer');
        const panelUpload = $('#panel-upload');

        function switchTab(name) {
            const ex = name === 'explorer';
            tabExplorer.classList.toggle('active', ex);
            tabExplorer.classList.toggle('border-b-2', ex);
            tabUpload.classList.toggle('active', !ex);
            tabUpload.classList.toggle('border-b-2', !ex);
            panelExplorer.classList.toggle('hidden', !ex);
            panelUpload.classList.toggle('hidden', ex);
            $('#currentPathHint').textContent = '/' + currentPath;
        }

        tabExplorer.addEventListener('click', () => switchTab('explorer'));
        tabUpload.addEventListener('click', () => switchTab('upload'));

        /* Explorer */
        async function browse() {
            const bucket = $('#bucketFilter').value.trim() || 'assets';
            const url = `/api/browse?bucket=${encodeURIComponent(bucket)}&rel_path=${encodeURIComponent(currentPath)}`;
            const r = await fetch(url);
            const j = await r.json();
            if (!j.ok) return;
            cacheFolders = j.folders || [];
            cacheFiles = j.files || [];
            renderCrumbs();
            renderGrid();
        }

        function renderCrumbs() {
            crumbs.innerHTML = '';
            const rootBtn = document.createElement('button');
            rootBtn.className = 'px-2 py-1 rounded hover:bg-slate-100';
            rootBtn.textContent = '/';
            rootBtn.addEventListener('click', () => {
                currentPath = '';
                browse();
            });
            crumbs.appendChild(rootBtn);

            if (!currentPath) return;
            const parts = currentPath.split('/');
            let acc = '';
            parts.forEach((part, idx) => {
                const sep = document.createElement('span');
                sep.textContent = 'â€º';
                sep.className = 'px-1 text-slate-400';
                crumbs.appendChild(sep);
                acc = joinPath(acc, part);
                const btn = document.createElement('button');
                btn.className = 'px-2 py-1 rounded hover:bg-slate-100';
                btn.textContent = part;
                btn.addEventListener('click', () => {
                    currentPath = parts.slice(0, idx + 1).join('/');
                    browse();
                });
                crumbs.appendChild(btn);
            });
        }

        function renderGrid() {
            grid.innerHTML = '';
            selected.clear();
            for (const f of cacheFolders) {
                const el = document.createElement('div');
                el.className = 'tile cursor-pointer';
                el.innerHTML = `<div class="text-2xl">${iconFolder()}</div>
      <div class="mt-2 font-medium truncate" title="${f}">${f}</div>
      <div class="text-xs text-slate-500">Folder</div>`;
                el.addEventListener('dblclick', () => {
                    currentPath = joinPath(currentPath, f);
                    browse();
                });
                el.addEventListener('click', () => { /* single click select? optional */
                });
                grid.appendChild(el);
            }
            for (const a of cacheFiles) {
                const el = document.createElement('div');
                el.className = 'tile';
                el.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div class="text-2xl">${iconFile(a.mime)}</div>
        <label class="text-xs text-slate-500 flex items-center gap-1">
          <input type="checkbox" data-name="${a.name}" class="rounded border-slate-300"> select
        </label>
      </div>
      <div class="mt-2 font-medium truncate" title="${a.name}">${a.name}</div>
      <div class="text-xs text-slate-500">${fmtSize(a.size)} Â· ${a.mime || ''}</div>
      <div class="mt-2 flex items-center gap-3">
        <a class="text-sky-600 underline text-sm" href="${a.url}" target="_blank">Open</a>
        <button class="text-sm text-slate-600 hover:text-slate-900" data-menu>â‹®</button>
      </div>
    `;
                // selection
                el.querySelector('input[type="checkbox"]').addEventListener('change', e => {
                    const name = e.target.dataset.name;
                    if (e.target.checked) selected.add(name); else selected.delete(name);
                });
                // context button
                el.querySelector('[data-menu]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showCtx(e, a);
                });
                grid.appendChild(el);
            }
            emptyState.classList.toggle('hidden', !!(cacheFolders.length || cacheFiles.length));
        }

        // Context menu
        function showCtx(ev, file) {
            ctxTarget = file;
            ctx.style.left = ev.clientX + 'px';
            ctx.style.top = ev.clientY + 'px';
            ctx.classList.remove('hidden');
        }

        document.addEventListener('click', () => ctx.classList.add('hidden'));
        ctx.addEventListener('click', async (e) => {
            const act = e.target.dataset.act;
            if (!act || !ctxTarget) return;
            ctx.classList.add('hidden');
            if (act === 'open') {
                window.open(ctxTarget.url, '_blank');
            }
            if (act === 'copy') {
                navigator.clipboard.writeText(location.origin + ctxTarget.url);
            }
            if (act === 'delete') {
                await deleteFile(ctxTarget.name);
            }
            if (act === 'rename') {
                await renameFile(ctxTarget.name);
            }
        });

        // New folder
        $('#btnNewFolder').addEventListener('click', async () => {
            const name = prompt('Folder name');
            if (!name) return;
            const bucket = $('#bucketFilter').value.trim() || 'assets';
            const r = await fetch('/api/mkdir', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({bucket, rel_path: currentPath, name})
            });
            const j = await r.json();
            if (!j.ok) {
                alert('Error: ' + (j.error || 'mkdir failed'));
                return;
            }
            browse();
        });

        // Rename / Move
        async function renameFile(oldName) {
            const bucket = $('#bucketFilter').value.trim() || 'assets';
            const newName = prompt('New name (keep extension):', oldName) || oldName;
            const moveTo = prompt('New path (relative, optional):', currentPath) || currentPath;
            const body = {
                bucket, old_rel_path: currentPath, old_name: oldName,
                new_rel_path: moveTo, new_name: newName
            };
            const r = await fetch('/api/rename', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            const j = await r.json();
            if (!j.ok) {
                alert('Error: ' + (j.error || 'rename failed'));
                return;
            }
            browse();
        }

        // Delete
        async function deleteFile(name) {
            if (!confirm('Delete this file?')) return;
            const bucket = $('#bucketFilter').value.trim() || 'assets';
            const r = await fetch('/api/delete', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({bucket, rel_path: currentPath, name})
            });
            const j = await r.json();
            if (!j.ok) {
                alert('Error: ' + (j.error || 'delete failed'));
                return;
            }
            browse();
        }

        /* Search (flat) */
        $('#bucketFilter').addEventListener('change', () => {
            currentPath = '';
            browse();
        });
        $('#q').addEventListener('input', debounce(listSearch, 300));

        async function listSearch() {
            const q = $('#q').value.trim();
            const bucket = $('#bucketFilter').value.trim();
            if (!q) {
                return browse();
            }
            const p = new URLSearchParams({q, bucket});
            const r = await fetch('/api/assets?' + p.toString());
            const j = await r.json();
            if (!j.ok) return;
            cacheFolders = [];
            cacheFiles = j.items.map(x => ({name: x.original_name, size: x.size, mime: x.mime, url: x.url}));
            renderCrumbs();
            renderGrid();
        }

        function debounce(fn, t) {
            let id;
            return (...a) => {
                clearTimeout(id);
                id = setTimeout(() => fn(...a), t);
            }
        }

        /* ZIP */
        $('#zipBtn').addEventListener('click', async () => {
            if (!selected.size) return;
            const bucket = $('#bucketFilter').value.trim() || 'assets';
            const items = Array.from(selected).map(n => ({bucket, rel_path: currentPath, name: n}));
            const r = await fetch('/api/zip', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({items})
            });
            if (!r.ok) return;
            const blob = await r.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'download.zip';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        /* Upload with real progress */
        const drop = $('#drop'), filesInput = $('#files'), folderInput = $('#folder');
        const queueList = $('#queue'), queueEmpty = $('#queueEmpty'), startBtn = $('#startUpload');
        let uploadQueue = [];
        let running = false;

        function addToQueue(file, relPath) {
            uploadQueue.push({file, rel_path: relPath || currentPath});
            queueEmpty.classList.add('hidden');
            const row = document.createElement('div');
            row.className = 'border rounded-lg p-2';
            row.dataset.name = file.name;
            row.innerHTML = `
    <div class="flex items-center justify-between gap-2">
      <div class="truncate">
        <div class="font-medium truncate" title="${file.name}">${file.name}</div>
        <div class="text-xs text-slate-500">${relPath ? relPath + '/' : ''}${file.name}</div>
      </div>
      <div class="text-xs" data-status>queued</div>
    </div>
    <div class="h-2 bg-slate-100 rounded overflow-hidden mt-2"><div class="h-2 w-0" data-bar style="background:#0f172a"></div></div>
  `;
            queueList.appendChild(row);
        }

        function setRow(name, {text, pct, cls}) {
            const row = queueList.querySelector(`div[data-name="${CSS.escape(name)}"]`);
            if (!row) return;
            if (text != null) {
                const st = row.querySelector('[data-status]');
                st.textContent = text;
                st.className = 'text-xs ' + (cls || '');
            }
            if (pct != null) {
                row.querySelector('[data-bar]').style.width = Math.max(0, Math.min(100, pct)) + '%';
            }
        }

        drop.addEventListener('dragover', e => {
            e.preventDefault();
            drop.classList.add('bg-slate-50');
        });
        drop.addEventListener('dragleave', () => drop.classList.remove('bg-slate-50'));
        drop.addEventListener('drop', e => {
            e.preventDefault();
            drop.classList.remove('bg-slate-50');
            for (const f of e.dataTransfer.files) {
                addToQueue(f, currentPath);
            }
        });
        filesInput.addEventListener('change', e => {
            for (const f of e.target.files) {
                addToQueue(f, currentPath);
            }
        });
        folderInput.addEventListener('change', e => {
            for (const f of e.target.files) {
                const rp = (f.webkitRelativePath || '').split('/').slice(0, -1).join('/');
                const rel = joinPath(currentPath, rp);
                addToQueue(f, rel);
            }
        });

        async function loadExts() {
            const r = await fetch('/api/allowed-extensions');
            const j = await r.json();
            $('#extInfo').textContent = j.ok ? `Allowed: ${j.items.join(', ')}` : 'Allowed: (error)';
        }

        startBtn.addEventListener('click', async () => {
            if (running || !uploadQueue.length) return;
            running = true;
            startBtn.disabled = true;
            const bucket = $('#bucket').value.trim() || 'assets';

            while (uploadQueue.length) {
                const {file, rel_path} = uploadQueue.shift();
                setRow(file.name, {text: 'uploadingâ€¦', pct: 0, cls: 'text-slate-600'});
                const fd = new FormData();
                fd.append('file', file);
                const url = `/api/upload?bucket=${encodeURIComponent(bucket)}&rel_path=${encodeURIComponent(rel_path)}`;
                try {
                    await xhrUpload(url, fd, (loaded, total) => {
                        const pct = total ? (loaded / total * 100) : 0;
                        setRow(file.name, {pct});
                    }).then(async (res) => {
                        const data = JSON.parse(res);
                        if (data.ok) {
                            setRow(file.name, {text: 'done âœ“', pct: 100, cls: 'text-green-700'});
                        } else {
                            setRow(file.name, {text: `error: ${data.error || 'failed'}`, cls: 'text-red-700'});
                        }
                    }).catch(() => setRow(file.name, {text: 'error: network', cls: 'text-red-700'}));
                } catch (e) {
                    setRow(file.name, {text: 'error', cls: 'text-red-700'});
                }
            }
            running = false;
            startBtn.disabled = false;
            await browse();
        });

        // XHR helper with progress
        function xhrUpload(url, formData, onProgress) {
            return new Promise((resolve, reject) => {
                const x = new XMLHttpRequest();
                x.open('POST', url);
                x.upload.onprogress = e => onProgress(e.loaded, e.total);
                x.onload = () => (x.status >= 200 && x.status < 300) ? resolve(x.responseText) : reject(x.responseText);
                x.onerror = () => reject('network');
                x.send(formData);
            });
        }

        $('#bucketFilter').addEventListener('change', () => $('#bucket').value = $('#bucketFilter').value);

        async function init() {
            await loadExts();
            switchTab('explorer');
            await browse();
            $('#bucket').value = $('#bucketFilter').value;
            $('#currentPathHint').textContent = '/' + currentPath;
        }

        init();
    </script>
{% endblock %}