<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EdgeCDN Dashboard</title>
  <!-- Tailwind via CDN for simplicity -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Subtle card shadow and smooth transitions */
    .card { box-shadow: 0 10px 25px rgba(0,0,0,.06); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-8">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">EdgeCDN</h1>
      <a href="/admin/" class="text-sm px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-black">Admin</a>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Upload card -->
      <section class="lg:col-span-1 bg-white rounded-2xl card p-6">
        <h2 class="font-semibold text-lg mb-4">Upload asset</h2>
        <form id="uploadForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Bucket</label>
            <input name="bucket" id="bucket" value="assets" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">File</label>
            <input type="file" id="file" name="file" class="w-full" required />
            <p id="extInfo" class="text-xs text-slate-500 mt-2">Allowed: loading…</p>
          </div>
          <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
            <div id="bar" class="h-2 w-0 bg-slate-900 transition-all"></div>
          </div>
          <button class="w-full rounded-xl bg-slate-900 text-white py-2 hover:bg-black">Upload</button>
          <p id="msg" class="text-sm"></p>
        </form>
      </section>

      <!-- Recent assets -->
      <section class="lg:col-span-2 bg-white rounded-2xl card p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold text-lg">Recent assets</h2>
          <input id="q" placeholder="Search…" class="rounded-xl border border-slate-200 px-3 py-2" />
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="py-2 pr-4">Bucket</th>
                <th class="py-2 pr-4">Name</th>
                <th class="py-2 pr-4">Size</th>
                <th class="py-2 pr-4">MIME</th>
                <th class="py-2 pr-4">Created</th>
                <th class="py-2 pr-4">URL</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const bar = $('#bar');
    const msg = $('#msg');

    async function loadExts(){
      const r = await fetch('/api/allowed-extensions');
      const j = await r.json();
      $('#extInfo').textContent = j.ok ? `Allowed: ${j.items.join(', ')}` : 'Allowed: (error)';
    }

    async function loadAssets(){
      const q = $('#q').value.trim();
      const r = await fetch('/api/assets' + (q ? ('?q='+encodeURIComponent(q)) : ''));
      const j = await r.json();
      if(!j.ok) return;
      const rows = j.items.map(a => `
        <tr class="border-t">
          <td class="py-2 pr-4">${a.bucket}</td>
          <td class="py-2 pr-4" title="${a.original_name}">${a.hashed_name}</td>
          <td class="py-2 pr-4">${formatSize(a.size)}</td>
          <td class="py-2 pr-4">${a.mime}</td>
          <td class="py-2 pr-4">${new Date(a.created_at).toLocaleString()}</td>
          <td class="py-2 pr-4"><a class="text-sky-600 underline" href="${a.url}" target="_blank">open</a></td>
        </tr>`).join('');
      $('#rows').innerHTML = rows || '<tr><td class="py-3 text-slate-500" colspan="6">No items</td></tr>';
    }

    function formatSize(bytes){
      const u = ['B', 'KB', 'MB', 'GB'];
      let i = 0, n = bytes;
      while(n >= 1024 && i < u.length - 1){ n/=1024; i++; }
      return n.toFixed( (i===0)?0:1 ) + ' ' + u[i];
    }

    $('#q').addEventListener('input', () => { loadAssets(); });

    $('#uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      bar.style.width = '0%';

      const file = $('#file').files[0];
      if(!file){ msg.textContent = 'Choose a file.'; return; }

      const fd = new FormData();
      fd.append('file', file);

      const bucket = $('#bucket').value || 'assets';
      const url = '/api/upload?bucket=' + encodeURIComponent(bucket);

      // Use fetch; show a fake progress bar to keep things simple
      bar.style.transition = 'width .2s';
      bar.style.width = '20%';

      try {
        const res = await fetch(url, { method: 'POST', body: fd });
        bar.style.width = '80%';
        const data = await res.json();
        if(!data.ok){ throw new Error(data.error || 'Upload failed'); }
        bar.style.width = '100%';
        msg.textContent = 'Uploaded ✓';
        msg.className = 'text-green-700';
        await loadAssets();
      } catch(err){
        msg.textContent = err.message || String(err);
        msg.className = 'text-red-700';
        bar.style.width = '0%';
      }
    });

    loadExts();
    loadAssets();
  </script>
</body>
</html>