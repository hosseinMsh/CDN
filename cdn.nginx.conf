# Minimal Nginx site for EdgeCDN

server {
    listen 80;
    server_name cdn.local;  # change to your domain

    # Django (gunicorn/uvicorn) upstream
    set $upstream 127.0.0.1:8000;

    # Serve dashboard & API via Django
    location /admin/ { proxy_pass http://$upstream$request_uri; include /etc/nginx/proxy_params; }
    location /dashboard/ { proxy_pass http://$upstream$request_uri; include /etc/nginx/proxy_params; }
    location /api/ { proxy_pass http://$upstream$request_uri; include /etc/nginx/proxy_params; }

    # Serve immutable assets directly from disk
    location /cdn/ {
        # Map /cdn/<bucket>/<pfx>/<sha>/<filename> to filesystem root
        alias /var/cdn/objects/;

        # Performance & safety
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        # CORS (adjust as needed)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Accept, Origin" always;
        if ($request_method = OPTIONS) { return 204; }

        # Client caching: filenames are versioned via hash => immutable
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Compression for text types (ensure nginx modules present)
        gzip on;
        gzip_types text/css application/javascript application/json image/svg+xml;

        # Prevent directory listing
        autoindex off;
    }
}